#+TITLE: Literate Emacs Configuration
#+AUTHOR: Julien Chedal-Anglay
* Personal Informations

#+BEGIN_SRC emacs-lisp
(setq-default user-full-name "Julien Chedal-Anglay"
              user-mail-address "chedala.julien@gmail.com")
#+END_SRC

* Encoding

#+BEGIN_SRC emacs-lisp
(setq-default locale-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
#+END_SRC

* Backups

#+BEGIN_SRC emacs-lisp
(setq-default backup-inhibited t
              auto-save-default nil
              create-lockfiles nil
              make-backup-files nil)
#+END_SRC

* Packages

#+BEGIN_SRC emacs-lisp
(require 'package)
(add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/") t)
(add-to-list 'package-archives '("melpa-stable" . "http://stable.melpa.org/packages/") t)
(package-initialize)

(unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
(eval-when-compile
  (require 'use-package))
(setq-default use-package-always-ensure t)
#+END_SRC

* Custom Variables

#+BEGIN_SRC emacs-lisp
(defconst custom-file "/dev/zero")
#+END_SRC

* System
** MacOS

#+BEGIN_SRC emacs-lisp
(use-package exec-path-from-shell
  :if (memq window-system '(mac ns))
  :demand t
  :config
  (exec-path-from-shell-initialize))
#+END_SRC

* GUI

#+BEGIN_SRC emacs-lisp
(when (display-graphic-p)
  (menu-bar-mode 0)
  (toggle-scroll-bar 0)
  (tool-bar-mode 0))
#+END_SRC

* Appearance
** Font

#+BEGIN_SRC emacs-lisp
(set-frame-font (if (memq window-system '(mac ns)) "Menlo-14" "FiraCode-10") nil t)
#+END_SRC

** Theme

#+BEGIN_SRC emacs-lisp
(use-package doom-themes
  :config
  (doom-themes-org-config)
  (load-theme 'doom-vibrant t))
#+END_SRC

** Modeline

#+BEGIN_SRC emacs-lisp
(line-number-mode t)
(column-number-mode t)

(use-package doom-modeline
  :if (display-graphic-p)
  :custom
  (doom-modeline-python-executable "python3")
  (doom-modeline-icon t)
  (doom-modeline-major-mode-icon t)
  (doom-modeline-version t)
  :config
  (doom-modeline-mode))
#+END_SRC

* Functions
** Dependencies

#+BEGIN_SRC emacs-lisp
(use-package popwin)
(use-package multi-term
  :custom
  (multi-term-program "/bin/zsh"))
#+END_SRC

** Definitions

#+BEGIN_SRC emacs-lisp
(defun ign:split-window-right ()
  (interactive)
  (split-window-right)
  (balance-windows))

(defun ign:split-window-below ()
  (interactive)
  (split-window-below)
  (balance-windows))

(defun ign:delete-window ()
  (interactive)
  (delete-window)
  (balance-windows))

(defun ign:popwin-term (name)
  (popwin:display-buffer-1
   (or (get-buffer name)
       (save-window-excursion
         (multi-term)))
   :default-config-keywords '(:height 15 :position :bottom :noselect nil :stick t))
   (rename-buffer name))

(defun ign:term-toggle ()
  (interactive)
  (cond
   ((get-buffer-window "*term*") (progn (switch-to-buffer "*term*") (kill-buffer-and-window)))
   ((get-buffer "*term*") (progn (kill-buffer "*term*") (ign:term-toggle)))
   (t (ign:popwin-term "*term*"))))

(defun ign:fill-or-unfill ()
  (interactive)
  (let ((fill-column
         (if (eq last-command 'endless/fill-or-unfill)
             (progn (setq this-command nil)
                    (point-max))
           fill-column)))
    (call-interactively #'fill-paragraph)))
#+END_SRC

* Interface
** Splash Screen

#+BEGIN_SRC emacs-lisp
(use-package dashboard
  :custom
  (dashboard-banner-logo-title
        (format "[Emacs ready in %.2f seconds with %d garbage collections.]"
                (float-time (time-subtract after-init-time before-init-time)) gcs-done))
  (dashboard-startup-banner 'logo)
  :config
  (dashboard-setup-startup-hook))
#+END_SRC

** Lines

#+BEGIN_SRC emacs-lisp
(setq-default transient-mark-mode t
              visual-line-mode t
              indent-tabs-mode nil
              tab-width 4)

(when (display-graphic-p)
  (global-hl-line-mode t))

(use-package linum
  :hook (prog-mode . linum-mode)
  :custom
  (linum-format " %d ")
  :config
  (set-face-underline 'linum nil))
#+END_SRC

** Scrolling

#+BEGIN_SRC emacs-lisp
(setq-default scroll-margin 0
              scroll-conservatively 10000
              scroll-preserve-screen-position t
              mouse-wheel-progressive-speed nil)
#+END_SRC

** Confirmation messages

#+BEGIN_SRC emacs-lisp
(defalias 'yes-or-no-p (lambda (&rest _) t))
(setq-default confirm-kill-emacs nil)
#+END_SRC

** Bells

#+BEGIN_SRC emacs-lisp
(setq-default visible-bell nil
              audible-bell nil
              ring-bell-function 'ignore)
#+END_SRC

* Completion Frontend

#+BEGIN_SRC emacs-lisp
(use-package ivy
  :bind
  ("C-x b" . ivy-switch-buffer)
  (:map ivy-minibuffer-map
   ("<return>" . ivy-alt-done))
  :custom
  (ivy-use-virtual-buffers t)
  (ivy-count-format "%d/%d ")
  (ivy-height 20)
  (ivy-display-style 'fancy)
  (ivy-format-function 'ivy-format-function-line)
  (ivy-re-builders-alist
      '((t . ivy--regex-plus)))
  (ivy-initial-inputs-alist nil))

(use-package counsel
  :bind
  (("M-x" . counsel-M-x)
   ("C-x C-f" . counsel-find-file)
   ("C-h v" . counsel-describe-variable)
   ("C-h f" . counsel-describe-function)))

(use-package swiper
  :bind
  ("C-s" . swiper))

(use-package all-the-icons-ivy
  :after ivy
  :config
  (setq-default all-the-icons-ivy-file-commands (append all-the-icons-ivy-file-commands '(counsel-projectile-find-file counsel-projectile-find-file-dwim)))
  (all-the-icons-ivy-setup))
#+END_SRC

* Org

#+BEGIN_SRC emacs-lisp
(use-package org
  :ensure nil
  :hook (org-babel-after-execute . org-redisplay-inline-images)
  :custom
  (org-image-actual-width 480)
  (org-src-fontify-natively t)
  (org-pretty-entities t)
  (org-hide-emphasis-markers t)
  (org-startup-with-inline-images t)
  (org-babel-python-command "ipython3 -i --simple-prompt")
  (org-format-latex-options (plist-put org-format-latex-options :scale 1.4))
  :config
  (use-package ob-ipython)
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((python . t)
     (ipython . t)
     (js . t)
     (ocaml . t)
     (gnuplot . t))))

(use-package org-bullets
  :hook (org-mode . org-bullets-mode))

(use-package px)
#+END_SRC

* Programming

#+BEGIN_SRC emacs-lisp
(use-package aggressive-indent
  :config
  (global-aggressive-indent-mode 1))

(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))

(use-package smartparens
  :hook (prog-mode . smartparens-mode)
  :custom
  (sp-escape-quotes-after-insert nil)
  :config
  (require 'smartparens-config))

(show-paren-mode t)
#+END_SRC

** Git

#+BEGIN_SRC emacs-lisp
(use-package magit
  :bind
  ("C-c g" . magit-status))

(use-package gitignore-mode
  :mode ("\\.gitignore\\'" . gitignore-mode))
#+END_SRC

** Auto-Completion

#+BEGIN_SRC emacs-lisp
(use-package company
  :bind
  ("M-/" . company-complete)
  (:map company-active-map
   ("M-n" . nil)
   ("M-p" . nil)
   ("C-n" . company-select-next)
   ("C-p" . company-select-previous))
  :custom-face
  (company-tooltip ((t (:foreground "#ABB2BF" :background "#30343C"))))
  (company-tooltip-annotation ((t (:foreground "#ABB2BF" :background "#30343C"))))
  (company-tooltip-selection ((t (:foreground "#ABB2BF" :background "#393F49"))))
  (company-tooltip-mouse ((t (:background "#30343C"))))
  (company-tooltip-common ((t (:foreground "#ABB2BF" :background "#30343C"))))
  (company-tooltip-common-selection ((t (:foreground "#ABB2BF" :background "#393F49"))))
  (company-preview ((t (:background "#30343C"))))
  (company-preview-common ((t (:foreground "#ABB2BF" :background "#30343C"))))
  (company-scrollbar-fg ((t (:background "#30343C"))))
  (company-scrollbar-bg ((t (:background "#30343C"))))
  (company-template-field ((t (:foreground "#282C34" :background "#C678DD"))))
  :custom
  (company-require-match 'never)
  (company-dabbrev-downcase nil)
  (company-tooltip-align-annotations t)
  (company-idle-delay 128)
  (company-minimum-prefix-length 128)
  :config
  (global-company-mode t))

(use-package company-quickhelp
  :if (display-graphic-p)
  :after company
  (company-quickhelp-mode))
#+END_SRC

** Snippets

#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :hook (prog-mode . yas-minor-mode)
  :config
  (use-package yasnippet-snippets))
#+END_SRC

** Checkers/Linters

#+BEGIN_SRC emacs-lisp
(use-package flycheck
  :custom-face
  (flycheck-info ((t (:underline (:style line :color "#80FF80")))))
  (flycheck-warning ((t (:underline (:style line :color "#FF9933")))))
  (flycheck-error ((t (:underline (:style line :color "#FF5C33")))))
  :custom
  (flycheck-check-syntax-automatically '(mode-enabled save))
  :config
  (define-fringe-bitmap 'flycheck-fringe-bitmap-ball
    (vector #b00000000
	    #b00000000
	    #b00000000
	    #b00000000
	    #b00000000
	    #b00111000
	    #b01111100
	    #b11111110
	    #b11111110
	    #b11111110
	    #b01111100
	    #b00111000
	    #b00000000
	    #b00000000
	    #b00000000
	    #b00000000
	    #b00000000))
  (flycheck-define-error-level 'info
    :severity 100
    :compilation-level 2
    :overlay-category 'flycheck-info-overlay
    :fringe-bitmap 'flycheck-fringe-bitmap-ball
    :fringe-face 'flycheck-fringe-info
    :info-list-face 'flycheck-error-list-info)
  (flycheck-define-error-level 'warning
    :severity 100
    :compilation-level 2
    :overlay-category 'flycheck-warning-overlay
    :fringe-bitmap 'flycheck-fringe-bitmap-ball
    :fringe-face 'flycheck-fringe-warning
    :warning-list-face 'flycheck-error-list-warning)
  (flycheck-define-error-level 'error
    :severity 100
    :compilation-level 2
    :overlay-category 'flycheck-error-overlay
    :fringe-bitmap 'flycheck-fringe-bitmap-ball
    :fringe-face 'flycheck-fringe-error
    :error-list-face 'flycheck-error-list-error)
  (global-flycheck-mode t))
#+END_SRC

** Project

#+BEGIN_SRC emacs-lisp
(use-package projectile
  :demand t
  :bind
  (:map projectile-mode-map
   ("C-c p" . projectile-command-map))
  :custom
  (projectile-project-search-path '("~/Projects/"))
  (projectile-indexing-method 'hybrid)
  (projectile-sort-order 'access-time)
  (projectile-enable-caching t)
  (projectile-require-project-root t)
  (projectile-completion-system 'ivy)
  :config
  (projectile-mode t)
  (counsel-projectile-mode))

(use-package counsel-projectile
  :after (counsel projectile))
#+END_SRC

** Python

#+BEGIN_SRC emacs-lisp
(use-package pip-requirements)

(use-package python
  :after flycheck
  :ensure nil
  :hook (python-mode . elpy-mode)
  :custom
  (python-indent 4)
  (python-shell-interpreter (if (memq window-system '(mac ns)) "ipython" "ipython3"))
  (python-shell-interpreter-args "--simple-prompt -i")
  (gud-pdb-command-name "python3 -m pdb")
  (python-fill-docstring-style 'pep-257)
  (py-split-window-on-execute t)
  (flycheck-python-pylint-executable "python3")
  (flycheck-python-pycompile-executable "python3"))

(use-package elpy
  :demand t
  :preface
  (defun python-before-save-hook ()
    (when (eq major-mode 'python-mode)
      (elpy-black-fix-code)))
  :after company
  :hook
  (python-mode . (lambda () (add-hook 'before-save-hook 'python-before-save-hook)))
  :custom
  (elpy-rpc-python-command "python3")
  :config
  (delete 'elpy-module-highlight-indentation elpy-modules)
  (delete 'elpy-module-flymake elpy-modules)
  (delete 'elpy-module-company elpy-modules)
  (add-to-list 'company-backends 'elpy-company-backend)
  (elpy-enable))
#+END_SRC

*** Jupyter

#+BEGIN_SRC emacs-lisp
(use-package ein
  :custom
  (ein:completion-backend 'ein:use-company-jedi-backends)
  (ein:use-auto-complete-superpack t))
#+END_SRC

** OCaml

#+BEGIN_SRC emacs-lisp
(use-package tuareg
  :after company
  :mode ("\\.mly\\'" . tuareg-menhir-mode)
  :custom
  (tuareg-match-patterns-aligned t)
  (tuareg-indent-align-with-first-arg t))

(use-package merlin
  :if (file-exists-p "~/.emacs.d/opam-user-setup.el")
  :after tuareg
  :hook (tuareg-mode . merlin-mode)
  :config
  (require 'opam-user-setup "~/.emacs.d/opam-user-setup.el"))
#+END_SRC

** C

#+BEGIN_SRC emacs-lisp
(use-package cc-mode
  :ensure nil
  :preface
  (define-auto-insert
    (cons "\\.\\([Hh]\\|hh\\|hpp\\)\\'" "C/C++ header")
    '(nil
      (let* ((noext (substring buffer-file-name 0 (match-beginning 0)))
             (nopath (file-name-nondirectory noext))
             (ident (concat (upcase nopath) "_H")))
        (concat "#ifndef " ident "\n"
                "# define " ident  "\n\n"
                "#endif\n"))))

  :hook
  (c-mode . (lambda () (setq indent-tabs-mode t)
                       (global-aggressive-indent-mode -1)))
  :custom
  (c-default-style "linux")
  (c-basic-offset 4))

(use-package srefactor
  :bind
  (:map c-mode-base-map
   ("C-c C-r" . srefactor-refactor-at-point))
  :hook ((c-mode c++-mode) . semantic-mode))

(use-package company-c-headers
  :demand t
  :after company
  :config
  (add-to-list 'company-backends 'company-c-headers))
#+END_SRC

** GNUplot

#+BEGIN_SRC emacs-lisp
(use-package gnuplot)
(use-package gnuplot-mode)
#+END_SRC

* Text Editing

#+BEGIN_SRC emacs-lisp
(setq-default require-final-newline t)
(global-subword-mode t)
(delete-selection-mode t)
(add-hook 'before-save-hook #'delete-trailing-whitespace)


(global-set-key [remap fill-paragraph] #'ign:fill-or-unfill)

(use-package expand-region
  :bind
  ("C-=" . er/expand-region))
#+END_SRC

* Text Navigation

#+BEGIN_SRC emacs-lisp
(use-package avy
  :bind
  ("C-'" . avy-goto-char-2)
  :custom
  (avy-keys '(?a ?o ?e ?u ?h ?t ?n ?s)))
#+END_SRC

* Bindings

#+BEGIN_SRC emacs-lisp
(keyboard-translate ?\C-t ?\C-x)
(keyboard-translate ?\C-x ?\C-t)

(define-key key-translation-map (kbd "M-t") (kbd "M-x"))
(define-key comint-mode-map (kbd "C-l") #'comint-clear-buffer)

(use-package bind-key)
(bind-key* "C-x k" 'ign:delete-window)
(bind-key* "C-c i" 'auto-insert)
(bind-key* "C-c w" 'ign:split-window-right)
(bind-key* "C-c t" 'ign:term-toggle)
#+END_SRC

** Which-key

#+BEGIN_SRC emacs-lisp
(use-package which-key
  :demand t
  :config
  (which-key-mode)
  :bind
  ("C-h m" . which-key-show-major-mode)
  ("C-h b" . which-key-show-top-level))
#+END_SRC

* Community
** Browser

#+BEGIN_SRC emacs-lisp
(setq-default browse-url-browser-function 'browse-url-chromium)
#+END_SRC

** Discord

#+BEGIN_SRC emacs-lisp
(use-package elcord
  :config
  (elcord-mode))
#+END_SRC
